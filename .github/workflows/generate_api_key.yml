name: API Key Generator

on:
  workflow_dispatch:
    inputs:
      email:
        description: "User Email"
        required: true
        type: string
        
permissions:
  contents: write
  actions: write

jobs:
  generate-api-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate API Key
        id: generate_key
        run: |
          API_KEY=$(openssl rand -hex 16)
          EXPIRY_DATE=$(date -d "+7 days" +"%Y-%m-%d")
          echo "API_KEY=$API_KEY" >> $GITHUB_ENV
          echo "EXPIRY_DATE=$EXPIRY_DATE" >> $GITHUB_ENV

      - name: Add API Key to Repository File
        run: |
          EXPIRY_SUFFIX=$(date -d "$EXPIRY_DATE" +"%m_%d_%Y")  # Format the expiry date as MONTH_DAY_YEAR
          echo -e "$API_KEY_$EXPIRY_SUFFIX" >> assets/rvr/rvr_trial.bin  # Append API key with expiry suffix
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          
          git add assets/rvr/rvr_trial.bin
          git commit -m "Add new API key to rvr_trial.bin"
          git push origin ${{ github.ref }}

      - name: Send API Key via Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASS }}
          subject: "Your API Key"
          to: "${{ inputs.email }}"
          from: "Runtime Video Recorder | API Key"
          body: "Hi! Here is your API key: ${{ env.API_KEY }}\nExpires on: ${{ env.EXPIRY_DATE }} Best wishes, Petr | Unreal Solutions"
