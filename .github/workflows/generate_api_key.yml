name: API Key Generator

on:
  workflow_dispatch:
    inputs:
      email:
        description: "User Email"
        required: true
        type: string
        
permissions:
  contents: write
  actions: write

jobs:
  generate-api-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate API Key
        id: generate_key
        run: |
          API_KEY=$(openssl rand -hex 16)
          EXPIRY_DATE=$(date -d "+7 days" +"%Y-%m-%d")
          echo "API_KEY=$API_KEY" >> $GITHUB_ENV
          echo "EXPIRY_DATE=$EXPIRY_DATE" >> $GITHUB_ENV

          EXPIRY_SUFFIX=$(date -d "$EXPIRY_DATE" +"%d_%m_%Y")  # Format the expiry date as MONTH_DAY_YEAR
          # echo -e "$API_KEY_$EXPIRY_SUFFIX" >> assets/rvr/rvr_trial.bin  # Append API key with expiry suffix
          # git config user.email "github-actions@github.com"
          # git config user.name "GitHub Actions"
          
          # git add assets/rvr/rvr_trial.bin
          # git commit -m "Add new API key to rvr_trial.bin"
          # git push origin ${{ github.ref }}
          
      - name: Read and Modify Email Body Template
        id: modify_email_body
        run: |
          # Read the HTML template file and replace the placeholders with actual values
          EMAIL_BODY=$(cat assets/email_body.html | sed "s/{{API_KEY}}/${{ env.API_KEY }}/g" | sed "s/{{EXPIRY_DATE}}/${{ env.EXPIRY_DATE }}/g")
          
      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.privateemail.com
          server_port: 465
          username: ${{SECRETS.EMAIL}}
          password: ${{SECRETS.PASSWORD}}
          subject: "Runtime Video Recorder | Your API Key"
          to: "${{ inputs.email }}"
          bcc: ${{SECRETS.BCC}}
          from: ${{SECRETS.FROM}}
          body: ${{ env.EMAIL_BODY }}  # Use the modified email body from the previous step
          secure: true
          ignore_cert: true
          convert_markdown: true
