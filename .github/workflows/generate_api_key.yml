name: API Key Generator

on:
  workflow_dispatch:
    inputs:
      email:
        description: "User Email"
        required: true
        type: string
      use_case:
        description: "Use Case"
        required: true
        type: string
      credits:
        description: "Recording credits for Supabase (credit-based licensing)"
        required: false
        type: integer
        default: 10

permissions:
  contents: read
  actions: write

jobs:
  generate-api-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate API Key
        id: generate_key
        run: |
            USER_EMAIL="${{ inputs.email }}"
            SALT="salty-salt-3214"
            API_KEY_HASH=$(echo -n "${SALT}${USER_EMAIL}$(date +%s)" | sha256sum | head -c 8 | tr '[:lower:]' '[:upper:]')
            RANDOM_SUFFIX=$(head -c 4 /dev/urandom | xxd -p | tr '[:lower:]' '[:upper:]')
            API_KEY="RVRTRIAL${API_KEY_HASH}${RANDOM_SUFFIX}"
            echo "Generated API_KEY: $API_KEY"
            echo "API_KEY=$API_KEY" >> $GITHUB_ENV

      - name: Add API key to Supabase (credits)
        run: |
          SUPABASE_URL="${{ secrets.SUPABASE_URL }}"
          SUPABASE_SERVICE_ROLE_KEY="${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
          API_KEY="${{ env.API_KEY }}"
          CREDITS="${{ inputs.credits }}"
          USER_EMAIL="${{ inputs.email }}"
          # Escape for JSON
          API_KEY_JSON=$(echo "$API_KEY" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\n/\\n/g')
          USER_EMAIL_JSON=$(echo "$USER_EMAIL" | sed 's/"/\\"/g')
          # Strip trailing slash
          SUPABASE_URL="${SUPABASE_URL%/}"
          echo "Adding API key to Supabase with $CREDITS credits for ${USER_EMAIL}"
          curl -s -X POST "${SUPABASE_URL}/rest/v1/rvr_api_keys" \
            -H "apikey: ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -H "Prefer: resolution=merge-duplicates" \
            -d "{\"api_key\": \"${API_KEY_JSON}\", \"credits_remaining\": ${CREDITS}, \"email\": \"${USER_EMAIL_JSON}\"}"
          echo "âœ… API key added to Supabase."
      
      - name: Trigger documentation deployment
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
      
      - name: Prepare email body
        run: |
          sed -e "s/{{API_KEY}}/${{ env.API_KEY }}/g" \
              -e "s/{{CREDITS}}/${{ inputs.credits }}/g" \
              assets/email_template.md > email.md
          
      - name: Send API Key Email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.privateemail.com
          server_port: 465
          username: ${{secrets.EMAIL}}
          password: ${{secrets.PASSWORD}}
          subject: "Runtime Video Recorder | Your API Key"
          to: "${{ inputs.email }}"
          bcc: ${{secrets.BCC}}
          from: ${{ secrets.FROM }}
          html_body: file://email.md  # Use the modified email body file
          secure: true
          ignore_cert: true
          convert_markdown: true
