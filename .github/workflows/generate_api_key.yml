name: API Key Generator

on:
  workflow_dispatch:
    inputs:
      email:
        description: "User Email"
        required: true
        type: string
        
permissions:
  contents: write
  actions: write

jobs:
  generate-api-key:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Generate API Key
        id: generate_key
        run: |
            # Get email input from the workflow
            USER_EMAIL="${{ inputs.email }}"

            # Generate a random API key using the email as a seed
            # Use SHA256 hash of email combined with random data for uniqueness
            API_KEY_HASH=$(echo -n "$USER_EMAIL$(date +%s)" | sha256sum | head -c 16)  # 16 characters from sha256 hash

            # Get the expiry date (7 days from now) in day-month-year format
            EXPIRY_DATE=$(date -d "+7 days" +"%d-%m-%Y")

            # Combine API key and expiry date in the format "API_KEY_26_03_2025"
            API_KEY="${API_KEY_HASH}_${EXPIRY_DATE}"

            # Debug: Check if variables are set
            echo "Generated API_KEY: $API_KEY"
            echo "Expiry Date: $EXPIRY_DATE"
            echo "Final API Key with Expiry: $API_KEY"
            
            echo "EXPIRY_DATE=$EXPIRY_DATE" >> $GITHUB_ENV
            echo "API_KEY=$API_KEY" >> $GITHUB_ENV

            # Append the final API key to the file
            echo "
            echo "$API_KEY" >> assets/rvr/rvr_trial.bin
      
      - name: Read and Modify Email Body Template
        id: modify_email_body
        run: |
          # Read the Markdown template file and replace the placeholders with actual values
          EMAIL_BODY=$(cat assets/email_template.md | sed "s/{{API_KEY}}/${{ env.API_KEY }}/g" | sed "s/{{EXPIRY_DATE}}/${{ env.EXPIRY_DATE }}/g")
          # Save the modified email body to a file
          echo "$EMAIL_BODY" > email.md
          
      - name: Send mail
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.privateemail.com
          server_port: 465
          username: ${{SECRETS.EMAIL}}
          password: ${{SECRETS.PASSWORD}}
          subject: "Runtime Video Recorder | Your API Key"
          to: "${{ inputs.email }}"
          bcc: ${{SECRETS.BCC}}
          from: ${{SECRETS.FROM}}
          html_body: file://email.md  # Use the modified email body file
          secure: true
          ignore_cert: true
          convert_markdown: true
